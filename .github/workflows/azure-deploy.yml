name: Azure Deploy

on:
  workflow_dispatch:
    inputs:
      run_number:
        description: 'CI workflow run number to deploy (leave blank for latest successful)'
        required: false
        type: string

permissions:
  contents: read

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Download specific run artifact
        if: github.event.inputs.run_number != ''
        uses: dawidd6/action-download-artifact@v3
        with:
          workflow: ci.yml
          run_number: ${{ github.event.inputs.run_number }}
          name: build-dist
          path: build

      - name: Download latest successful artifact
        if: github.event.inputs.run_number == ''
        uses: dawidd6/action-download-artifact@v3
        with:
          workflow: ci.yml
          workflow_conclusion: success
          name: build-dist
          path: build

      - name: List downloaded files
        run: ls -R build

      - name: Install production dependencies
        working-directory: build
        run: |
          if [ -f package-lock.json ]; then npm ci --omit=dev; else npm install --omit=dev; fi

      - name: Smoke test artifact (/health)
        working-directory: build
        run: |
          PORT=4010 node dist/index.js &
          server_pid=$!
          tries=0
          until curl -fs http://localhost:4010/health >/dev/null 2>&1 || [ $tries -ge 15 ]; do
            sleep 1
            tries=$((tries+1))
          done
          if ! curl -fs http://localhost:4010/health; then
            echo "Health check failed" >&2
            kill $server_pid || true
            exit 1
          fi
          echo "Health endpoint responded successfully"
          kill $server_pid || true

      - name: Deploy to Azure Web App (artifact)
        uses: azure/webapps-deploy@v3
        with:
          app-name: ${{ vars.AZURE_WEBAPP_NAME }}
          publish-profile: ${{ secrets.AZURE_WEBAPP_PUBLISH_PROFILE }}
          slot-name: production
          package: build

      - name: Output deployment URL
        run: echo "App deployed to https://${{ vars.AZURE_WEBAPP_NAME }}.azurewebsites.net from run number '${{ github.event.inputs.run_number != '' && github.event.inputs.run_number || 'latest' }}'"
